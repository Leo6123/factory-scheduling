# 如何檢查 RLS 函數是否存在

## 📋 詳細步驟說明

### 步驟 1：打開 Supabase Dashboard

1. 打開瀏覽器，訪問 [Supabase Dashboard](https://app.supabase.com/)
2. 登入您的 Supabase 帳號
3. 選擇您的專案（例如：`factory-scheduling`）

---

### 步驟 2：進入 SQL Editor

1. 在左側導航欄中，找到 **"SQL Editor"**（SQL 編輯器）
   - 圖標通常是一個 `< >` 或 `</>` 符號
   - 文字標籤是 "SQL Editor"
2. 點擊 **"SQL Editor"**

---

### 步驟 3：創建新查詢

在 SQL Editor 頁面中，您會看到：

#### 方法 A：使用 "New Query" 按鈕（推薦）

1. 在 SQL Editor 頁面頂部或左側，找到 **"New Query"**（新查詢）按鈕
   - 通常是一個綠色的 **"+"** 按鈕或 **"New Query"** 文字按鈕
2. 點擊 **"New Query"** 按鈕
3. 這會創建一個新的查詢標籤頁

#### 方法 B：如果沒有 "New Query" 按鈕

1. 直接在 SQL Editor 的主要編輯區域（中央大框）中點擊
2. 如果已有其他查詢，您可以：
   - 點擊現有查詢標籤旁邊的 **"+"** 按鈕來創建新查詢
   - 或者直接在現有查詢中清除內容並貼上新的 SQL

---

### 步驟 4：貼上 SQL 查詢

1. 複製以下 SQL 代碼：

```sql
SELECT 
  proname as "函數名稱",
  prorettype::regtype as "返回類型",
  pg_get_function_arguments(oid) as "參數"
FROM pg_proc
WHERE proname IN ('get_user_role', 'get_user_role_safe')
AND pronamespace = 'public'::regnamespace;
```

2. 在 SQL Editor 的編輯區域中貼上（`Ctrl + V` 或 `Cmd + V`）

---

### 步驟 5：執行查詢

執行查詢有幾種方法：

#### 方法 A：使用按鈕（推薦）

1. 在 SQL Editor 的右上角或底部，找到 **"Run"**（執行）按鈕
   - 通常是一個綠色的按鈕，文字是 "Run" 或 "RUN"
   - 或者是一個播放圖標（▶️）
2. 點擊 **"Run"** 按鈕

#### 方法 B：使用快捷鍵

1. 按下鍵盤快捷鍵：**`Ctrl + Enter`**（Windows/Linux）或 **`Cmd + Enter`**（Mac）
2. 這會立即執行查詢

---

### 步驟 6：查看結果

執行查詢後，您會在 SQL Editor 下方看到結果區域：

1. **結果表格**：會顯示查詢結果
   - 如果函數存在，您會看到一個表格，包含以下欄位：
     - **函數名稱**（`proname`）
     - **返回類型**（`prorettype`）
     - **參數**（`pg_get_function_arguments`）

2. **預期結果**：
   - 應該返回 **2 行**（兩個函數都存在）：
     - `get_user_role` - 函數名稱
     - `get_user_role_safe` - 函數名稱
   - 如果只返回 1 行或 0 行，表示函數可能不存在

---

### 步驟 7：解讀結果

#### ✅ 成功的情況（函數存在）

如果查詢返回 **2 行**：

| 函數名稱 | 返回類型 | 參數 |
|---------|---------|------|
| `get_user_role` | `text` | (無參數) |
| `get_user_role_safe` | `text` | (無參數) |

這表示兩個函數都存在，✅ **檢查通過**

#### ❌ 失敗的情況（函數不存在）

如果查詢返回 **0 行** 或只有 1 行：

- 表示函數不存在或未正確創建
- 需要執行 `supabase_secure_rls_policies.sql` 腳本來創建函數

---

## 📸 視覺指引

如果您在 Supabase SQL Editor 中：

```
┌─────────────────────────────────────────┐
│  Supabase Dashboard                     │
│  ┌─────────────────────────────────┐   │
│  │ SQL Editor    [New Query] [+]   │   │
│  ├─────────────────────────────────┤   │
│  │                                 │   │
│  │  [SQL 查詢代碼編輯區域]          │   │
│  │                                 │   │
│  │  SELECT ...                     │   │
│  │  FROM pg_proc ...               │   │
│  │                                 │   │
│  ├─────────────────────────────────┤   │
│  │ [Run] [Explain] [Chart]         │   │
│  ├─────────────────────────────────┤   │
│  │ Results                         │   │
│  │ ┌─────────┬─────────┬─────────┐ │   │
│  │ │ 函數名稱 │ 返回類型 │  參數   │ │   │
│  │ ├─────────┼─────────┼─────────┤ │   │
│  │ │get_user_│  text   │         │ │   │
│  │ │  role   │         │         │ │   │
│  │ ├─────────┼─────────┼─────────┤ │   │
│  │ │get_user_│  text   │         │ │   │
│  │ │role_safe│         │         │ │   │
│  │ └─────────┴─────────┴─────────┘ │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

---

## 🔧 如果函數不存在

如果查詢返回 0 行，表示函數不存在，需要執行以下步驟：

### 1. 執行 RLS 政策腳本

1. 在 SQL Editor 中創建新查詢
2. 打開 `supabase_secure_rls_policies.sql` 文件
3. 複製整個文件內容
4. 貼上到 SQL Editor 中
5. 點擊 **"Run"** 執行
6. 等待執行完成（可能需要幾秒鐘）

### 2. 再次檢查函數

1. 執行上述檢查函數的 SQL 查詢
2. 確認現在返回 2 行（函數已創建）

---

## ❓ 常見問題

### Q1: 找不到 "New Query" 按鈕

**A**: 可以直接在 SQL Editor 的主要編輯區域中貼上 SQL 代碼，然後點擊 "Run" 按鈕。

### Q2: 查詢執行失敗

**A**: 
- 檢查 SQL 語法是否正確
- 確認已正確複製所有 SQL 代碼（包括結尾的分號 `;`）
- 查看錯誤訊息，通常會指出問題所在

### Q3: 結果區域沒有顯示

**A**:
- 確認查詢已執行（按鈕變為灰色或顯示執行中）
- 檢查是否有錯誤訊息
- 嘗試滾動頁面查看結果區域

### Q4: 只返回 1 行（只有一個函數）

**A**:
- 如果只有 `get_user_role`，表示 `get_user_role_safe` 函數不存在
- 需要執行 `supabase_secure_rls_policies.sql` 來創建缺失的函數

---

## 📝 下一步

檢查完函數是否存在後，請：

1. 記錄檢查結果（存在或不存在）
2. 如果不存在，執行 `supabase_secure_rls_policies.sql` 創建函數
3. 繼續下一步：檢查 RLS 是否已啟用
