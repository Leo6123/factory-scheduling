# API 速率限制實施影響分析

**分析日期：** 2026-01-20  
**受影響 API：** `/api/google-sheets`  
**用途：** 讀取 Google Sheets QC 狀態資料

---

## 📊 當前 API 使用情況

### API 呼叫頻率

根據程式碼分析，Google Sheets API 的呼叫模式如下：

| 觸發時機 | 頻率 | 每次請求數 | 說明 |
|---------|------|-----------|------|
| **頁面載入時** | 1 次 | 1 | 初次載入 QC 資料 |
| **定期重新載入** | 每 5 分鐘 | 1 | 自動更新 QC 狀態 |
| **手動重新載入** | 使用者觸發 | 1 | 使用者點擊重新整理 |
| **批號查詢** | 即時查詢 | 0 | 使用已快取的資料，不觸發 API |

### 使用場景

1. **QC 狀態顯示** (`useQCStatus` Hook)
   - 頁面載入時自動載入一次
   - 之後每 5 分鐘自動重新載入
   - 使用 5 分鐘快取機制，避免重複請求

2. **批號搜尋** (`BatchSearch` 組件)
   - 僅查詢本地快取資料
   - **不觸發 API 請求**

### 當前請求估算

**正常使用情境（單一用戶）：**
- 每小時：約 12-15 次請求（1 次初始載入 + 12 次定期更新）
- 每天：約 288-360 次請求

**多用戶情境（假設 10 個同時在線用戶）：**
- 每小時：約 120-150 次請求
- 每天：約 2,880-3,600 次請求

---

## 🎯 速率限制建議設定

### 建議方案 A：寬鬆限制（適合正常使用）

```
每 IP 每分鐘：30 次請求
每 IP 每小時：1000 次請求
```

**適用場景：**
- 小型團隊（5-20 人）
- 正常使用模式
- 不會影響現有功能

### 建議方案 B：中等限制（平衡安全與使用）

```
每 IP 每分鐘：20 次請求
每 IP 每小時：500 次請求
```

**適用場景：**
- 中型團隊（10-50 人）
- 需要防止濫用
- 輕微影響快速重新載入的情況

### 建議方案 C：嚴格限制（最高安全性）

```
每 IP 每分鐘：10 次請求
每 IP 每小時：200 次請求
```

**適用場景：**
- 需要嚴格防止濫用
- 可能影響快速重新載入
- 不適合高頻操作

---

## ⚠️ 實施速率限制的影響

### ✅ 正面影響

#### 1. **安全性提升**
- ✅ **防止 DDoS 攻擊**：惡意用戶無法快速發送大量請求癱瘓服務
- ✅ **防止 API Key 濫用**：即使 API Key 洩露，攻擊者也無法無限制使用
- ✅ **降低成本風險**：避免因濫用導致 Google API 配額超限產生額外費用

#### 2. **服務穩定性**
- ✅ **保護伺服器資源**：避免單一用戶或攻擊消耗過多資源
- ✅ **公平使用**：確保所有用戶都能正常使用服務

### ⚠️ 負面影響與風險

#### 1. **對正常用戶的影響**

##### 影響程度：**低** ⚠️

**原因：**
- 當前使用模式是**每 5 分鐘載入一次**
- 正常用戶每分鐘最多 1-2 次請求
- **建議方案 A (30 次/分鐘) 不會影響正常使用**

**可能情況：**
- 如果用戶連續點擊「重新整理」按鈕（快速點擊 30+ 次）
- 可能會觸發速率限制

**解決方案：**
- 添加「重新整理」按鈕的防抖機制（debounce）
- 在 UI 上顯示「請稍候，資料載入中...」提示

#### 2. **對系統功能的影響**

##### 2.1 QC 狀態自動更新

**影響：** ⚠️ **極低風險**

**分析：**
- 當前機制：每 5 分鐘自動載入一次
- 速率限制（方案 A）：30 次/分鐘
- **影響：無** ✅

##### 2.2 頁面載入

**影響：** ⚠️ **無影響**

**分析：**
- 頁面載入時只會發送 1 次請求
- **影響：無** ✅

##### 2.3 手動重新載入

**影響：** ⚠️ **極低風險**

**分析：**
- 如果用戶在 1 分鐘內點擊重新載入超過 30 次
- 才會觸發限制
- **正常使用情況下幾乎不可能** ✅

#### 3. **對多用戶情境的影響**

##### 影響程度：**中等** ⚠️

**情境：** 多個用戶同時使用系統

**問題：**
- 如果多個用戶共用同一 IP（例如公司網路使用 NAT）
- 可能觸發速率限制

**解決方案：**
- **方案 1**：改為**基於用戶身份的限制**（而不是 IP）
  - 優點：更公平，不會影響共用 IP 的用戶
  - 缺點：需要身份驗證（建議先實施）

- **方案 2**：提高速率限制（方案 A：30 次/分鐘）
  - 優點：簡單實施
  - 缺點：無法區分用戶

- **方案 3**：混合方案
  - IP 基礎限制：50 次/分鐘（共用 IP 保護）
  - 用戶身份限制：20 次/分鐘（防止單一用戶濫用）

---

## 📋 影響評估總表

| 影響項目 | 風險等級 | 影響描述 | 緩解措施 |
|---------|---------|---------|---------|
| **正常用戶使用** | 🟢 低 | 5 分鐘載入一次，不會觸發限制 | 無需特別處理 |
| **手動重新載入** | 🟢 低 | 除非 1 分鐘內點擊 30+ 次 | 添加防抖機制 |
| **多用戶共用 IP** | 🟡 中 | 可能觸發限制 | 改為用戶身份限制 |
| **DDoS 攻擊防護** | 🟢 優 | 有效防止濫用 | - |
| **API Key 濫用防護** | 🟢 優 | 限制單一 IP 使用量 | - |

---

## 🛠️ 實施建議

### 階段 1：基本速率限制（立即實施）

**設定：**
- 每 IP 每分鐘：30 次
- 每 IP 每小時：1000 次

**優點：**
- 快速實施
- 不影響正常使用
- 有效防止濫用

**實施方式：**
```typescript
// middleware.ts 或 API Route
const rateLimit = 30; // 每分鐘
const windowMs = 60 * 1000; // 1 分鐘
```

### 階段 2：基於用戶的速率限制（建議後續實施）

**前提：** 先完成 API 路由身份驗證

**設定：**
- 每用戶每分鐘：20 次
- 每 IP 每分鐘：50 次（備用保護）

**優點：**
- 更公平的分配
- 不影響共用 IP 的用戶

### 階段 3：動態調整（長期規劃）

**功能：**
- 根據使用模式自動調整限制
- 對信任用戶提高限制
- 對可疑行為降低限制

---

## 📊 速率限制實施後的預期行為

### 正常使用情況

```
時間軸：
00:00 - 用戶登入，載入 QC 資料（請求 1，成功 ✅）
00:05 - 自動重新載入（請求 2，成功 ✅）
00:10 - 自動重新載入（請求 3，成功 ✅）
...
```

**結果：** ✅ 無影響，正常運作

### 觸發限制情況

```
時間軸：
00:00 - 用戶登入，載入 QC 資料（請求 1，成功 ✅）
00:00 - 用戶連續點擊重新載入 30 次
00:00 - 第 31 次請求（觸發限制 ⚠️）
00:01 - 限制重置，請求成功 ✅
```

**結果：** ⚠️ 最後一次請求會被拒絕，返回 429 狀態碼

**用戶體驗：**
- 顯示友善的錯誤訊息：「請求過於頻繁，請稍候再試」
- 自動重試機制（指數退避）

---

## 🔧 實施後的改進建議

### 1. **錯誤處理**

當速率限制被觸發時（HTTP 429），應該：

```typescript
if (response.status === 429) {
  // 顯示友善訊息
  showMessage('請求過於頻繁，將自動重試...');
  
  // 指數退避重試
  setTimeout(() => retryRequest(), 5000);
}
```

### 2. **UI 改進**

- 添加「重新載入」按鈕的防抖機制
- 顯示請求狀態（載入中、成功、失敗）
- 提示用戶「資料每 5 分鐘自動更新」

### 3. **監控與告警**

- 記錄所有 429 回應
- 監控異常的請求模式
- 當觸發限制時發送告警（如果需要）

---

## 💰 成本影響

### 正面影響

- ✅ **降低 Google API 配額消耗**
  - 防止濫用避免配額超限
  - 減少不必要的 API 呼叫

- ✅ **降低 Vercel 伺服器成本**
  - 減少伺服器負載
  - 降低 Edge Function 執行次數

### 負面影響

- ⚠️ **無**（速率限制不會增加成本）

---

## ✅ 結論

### 整體評估

**建議實施速率限制：** ✅ **強烈建議**

**理由：**
1. ✅ 安全性提升（防止 DDoS、API Key 濫用）
2. ✅ 對正常用戶影響極小（當前使用模式不會觸發限制）
3. ✅ 服務穩定性提升
4. ✅ 成本風險降低

### 建議方案

**立即實施：**
- 每 IP 每分鐘：30 次請求
- 每 IP 每小時：1000 次請求

**後續改進：**
- 添加身份驗證後，改為基於用戶的限制
- 實施友善的錯誤處理和重試機制

### 預期結果

- ✅ **99% 的用戶不受影響**
- ✅ **有效防止濫用和攻擊**
- ✅ **系統穩定性和安全性提升**

---

**評估人員：** AI Assistant  
**下次評估日期：** 實施後 1 個月
