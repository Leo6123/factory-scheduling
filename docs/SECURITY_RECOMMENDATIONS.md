# 資安設定建議與實作方案

## 📋 當前安全狀況分析

### ⚠️ 現有安全風險

1. **無身份驗證機制**
   - 任何人都可以訪問應用
   - 沒有登入系統

2. **資料庫安全**
   - 使用匿名金鑰（`NEXT_PUBLIC_SUPABASE_ANON_KEY`）公開可見
   - RLS 政策允許所有操作（`USING (true) WITH CHECK (true)`）
   - 任何人都可以讀寫資料庫

3. **API 金鑰暴露**
   - Google API Key 暴露在前端代碼中
   - 任何人都可以在瀏覽器中查看和使用

4. **無訪問控制**
   - 匯入/匯出功能無權限控制
   - 所有操作都公開可用

5. **無輸入驗證**
   - 缺乏伺服器端驗證
   - 依賴客戶端驗證（可繞過）

---

## 🛡️ 資安建議（分階段實作）

### **階段 1：基本保護（立即實施）** ⭐ 優先級最高

#### 1.1 強化 Supabase RLS 政策
- ✅ 啟用 Row Level Security
- ✅ 建立基於身份的訪問控制政策
- ✅ 限制匿名用戶的操作權限

**風險等級**：🔴 高風險  
**實作難度**：🟢 簡單  
**影響範圍**：資料庫層面

#### 1.2 環境變數保護
- ✅ 確保敏感資訊不暴露在前端
- ✅ 使用環境變數管理所有 API 金鑰
- ✅ 移除開發環境中的調試代碼

**風險等級**：🟡 中風險  
**實作難度**：🟢 簡單  
**影響範圍**：配置管理

#### 1.3 輸入驗證增強
- ✅ 伺服器端驗證文件大小和格式
- ✅ 驗證 Excel 文件內容合法性
- ✅ 防止 SQL 注入和 XSS 攻擊

**風險等級**：🟡 中風險  
**實作難度**：🟡 中等  
**影響範圍**：數據處理

---

### **階段 2：身份驗證與授權（核心功能）** ⭐⭐ 高優先級

#### 2.1 實作 Supabase Auth
- ✅ 用戶登入系統（Email/Password、Magic Link、OAuth）
- ✅ 會話管理（JWT Token）
- ✅ 自動刷新 Token

**風險等級**：🔴 高風險  
**實作難度**：🟡 中等  
**影響範圍**：整個應用

#### 2.2 基於角色的訪問控制（RBAC）
- ✅ 定義角色：管理員、操作員、訪客
- ✅ 實作權限檢查中間件
- ✅ 限制功能訪問（匯入/匯出/清除）

**風險等級**：🔴 高風險  
**實作難度**：🟡 中等  
**影響範圍**：功能訪問控制

#### 2.3 基於 RLS 的數據訪問控制
- ✅ 根據用戶角色限制數據訪問
- ✅ 實作數據過濾政策
- ✅ 防止未授權數據讀取

**風險等級**：🔴 高風險  
**實作難度**：🟡 中等  
**影響範圍**：資料庫訪問

---

### **階段 3：進階安全措施（強化保護）** ⭐⭐⭐ 長期規劃

#### 3.1 API 端點保護
- ✅ 建立 Next.js API Routes 作為後端代理
- ✅ 實作 Rate Limiting（請求頻率限制）
- ✅ API 認證和授權

**風險等級**：🟡 中風險  
**實作難度**：🔴 困難  
**影響範圍**：API 層面

#### 3.2 IP 白名單（Vercel）
- ✅ 限制只有特定 IP 可以訪問
- ✅ 企業內網訪問控制

**風險等級**：🟢 低風險  
**實作難度**：🟢 簡單  
**影響範圍**：網路層面

#### 3.3 審計日誌
- ✅ 記錄所有重要操作（匯入/匯出/刪除）
- ✅ 追蹤用戶活動
- ✅ 異常行為檢測

**風險等級**：🟡 中風險  
**實作難度**：🟡 中等  
**影響範圍**：監控與合規

#### 3.4 數據加密
- ✅ 敏感數據加密存儲
- ✅ 傳輸加密（HTTPS）
- ✅ 客戶端數據加密

**風險等級**：🟡 中風險  
**實作難度**：🔴 困難  
**影響範圍**：數據保護

---

## 📊 優先級建議

| 優先級 | 項目 | 風險等級 | 實作難度 | 建議實施時間 |
|--------|------|----------|----------|--------------|
| **P0** | 強化 RLS 政策 | 🔴 高 | 🟢 簡單 | **立即** |
| **P0** | 實作身份驗證 | 🔴 高 | 🟡 中等 | **1-2 週** |
| **P1** | 角色權限控制 | 🔴 高 | 🟡 中等 | **2-3 週** |
| **P1** | 輸入驗證增強 | 🟡 中 | 🟡 中等 | **1 週** |
| **P2** | API 端點保護 | 🟡 中 | 🔴 困難 | **3-4 週** |
| **P2** | 審計日誌 | 🟡 中 | 🟡 中等 | **2 週** |
| **P3** | IP 白名單 | 🟢 低 | 🟢 簡單 | **按需** |
| **P3** | 數據加密 | 🟡 中 | 🔴 困難 | **長期規劃** |

---

## 🔧 實作方案選項

### **方案 A：基本保護（MVP）**
- ✅ Supabase Auth（Email/Password）
- ✅ 強化 RLS 政策（基於用戶身份）
- ✅ 基本角色控制（管理員/操作員）

**適用場景**：內部使用，少量用戶  
**實作時間**：1-2 週  
**成本**：低（使用 Supabase 免費方案）

### **方案 B：標準保護（推薦）**
- ✅ Supabase Auth（多種登入方式）
- ✅ 完整的 RBAC 系統
- ✅ API 端點保護
- ✅ 審計日誌

**適用場景**：生產環境，多用戶  
**實作時間**：3-4 週  
**成本**：中（Supabase Pro 方案）

### **方案 C：企業級保護（進階）**
- ✅ 方案 B 的所有功能
- ✅ IP 白名單
- ✅ 數據加密
- ✅ 單點登入（SSO）
- ✅ 完整的審計和合規

**適用場景**：企業環境，高安全要求  
**實作時間**：2-3 個月  
**成本**：高（Supabase Enterprise）

---

## 🚀 建議實作順序

### **第一階段（1 週內）**
1. 強化 Supabase RLS 政策
2. 移除開發環境調試代碼
3. 環境變數安全檢查

### **第二階段（2-3 週）**
1. 實作 Supabase Auth 登入系統
2. 建立基本角色系統（管理員/操作員）
3. 實作功能權限控制

### **第三階段（1-2 週）**
1. 輸入驗證增強
2. 審計日誌實作
3. 錯誤處理改善

### **第四階段（按需）**
1. API 端點保護
2. Rate Limiting
3. 進階安全措施

---

## 📝 注意事項

1. **向後兼容**：實作安全措施時，確保不破壞現有功能
2. **分階段部署**：逐步實施，每階段測試確認
3. **用戶體驗**：平衡安全性和易用性
4. **性能影響**：考慮安全檢查對性能的影響
5. **文檔更新**：更新用戶文檔和開發文檔

---

## 🔗 相關資源

- [Supabase Auth 文檔](https://supabase.com/docs/guides/auth)
- [Supabase RLS 文檔](https://supabase.com/docs/guides/auth/row-level-security)
- [Next.js 安全最佳實踐](https://nextjs.org/docs/app/building-your-application/configuring/security)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)

---

## ❓ 下一步

請選擇要實作的方案：
1. **方案 A：基本保護**（推薦從這裡開始）
2. **方案 B：標準保護**（生產環境推薦）
3. **方案 C：企業級保護**（高安全要求）

或指定要優先實作的功能。
