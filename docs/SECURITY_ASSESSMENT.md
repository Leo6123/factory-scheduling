# 工廠排程系統 APS - 資安評估表

**評估日期：** 2026-01-20  
**系統版本：** v0.1.0  
**評估範圍：** 前端應用、後端 API、資料庫安全

---

## 📊 資安等級總評

**整體評級：** ⭐⭐⭐⭐ (4/5) - **良好**

**評級說明：**
- ⭐⭐⭐⭐⭐ (5/5) - 優秀：符合企業級安全標準
- ⭐⭐⭐⭐ (4/5) - 良好：主要安全措施已實施，有少量改進空間
- ⭐⭐⭐ (3/5) - 中等：基本安全措施已實施，需要加強
- ⭐⭐ (2/5) - 不足：存在明顯安全漏洞
- ⭐ (1/5) - 危險：存在嚴重安全漏洞

---

## 🔐 1. 認證與授權 (Authentication & Authorization)

| 項目 | 狀態 | 評級 | 說明 |
|------|------|------|------|
| 用戶認證 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | 使用 Supabase Auth，支援 Email/Password 登入 |
| 密碼重設 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | 支援忘記密碼功能，使用 Supabase 內建機制 |
| 角色基礎存取控制 (RBAC) | ✅ 已實施 | ⭐⭐⭐⭐⭐ | 三種角色：admin、operator、viewer |
| 權限檢查 | ✅ 已實施 | ⭐⭐⭐⭐ | 前端權限檢查完整，但需加強後端驗證 |
| 會話管理 | ✅ 已實施 | ⭐⭐⭐⭐ | Supabase Session 管理，支援單一裝置登入 |
| 多分頁檢測 | ✅ 已實施 | ⭐⭐⭐⭐ | 使用 BroadcastChannel 檢測多分頁登入 |
| JWT Token | ✅ 已實施 | ⭐⭐⭐⭐⭐ | Supabase 自動管理 JWT Token |
| Token 過期處理 | ✅ 已實施 | ⭐⭐⭐⭐ | Supabase 自動處理 Token 刷新 |

**改進建議：**
- [ ] 實施雙因素認證 (2FA)
- [ ] 增加登入失敗次數限制
- [ ] 實施帳號鎖定機制
- [ ] 記錄所有登入/登出活動

---

## 🛡️ 2. 資料庫安全 (Database Security)

| 項目 | 狀態 | 評級 | 說明 |
|------|------|------|------|
| Row Level Security (RLS) | ✅ 已啟用 | ⭐⭐⭐⭐⭐ | 所有表已啟用 RLS |
| RLS 政策 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | 基於角色的完整 RLS 政策 |
| 資料庫連線加密 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | Supabase 使用 SSL/TLS |
| SQL 注入防護 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | 使用 Supabase 參數化查詢 |
| 資料備份 | ✅ 已實施 | ⭐⭐⭐⭐ | Supabase Pro 方案提供自動備份 |
| 資料庫存取控制 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | 使用 Anon Key 和 Service Role Key 分離 |

**改進建議：**
- [ ] 定期審查 RLS 政策
- [ ] 實施資料庫審計日誌
- [ ] 考慮資料加密 (Encryption at Rest)

---

## 🔒 3. API 安全 (API Security)

| 項目 | 狀態 | 評級 | 說明 |
|------|------|------|------|
| API Key 保護 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | Google API Key 在伺服器端，不暴露給客戶端 |
| 環境變數管理 | ✅ 已實施 | ⭐⭐⭐⭐ | 使用 .env.local 和 Vercel 環境變數 |
| API 路由保護 | ⚠️ 部分實施 | ⭐⭐⭐ | Google Sheets API 路由未驗證用戶身份 |
| 速率限制 | ❌ 未實施 | ⭐⭐ | 無 API 速率限制 |
| CORS 設定 | ✅ 已實施 | ⭐⭐⭐⭐ | Next.js 預設 CORS 設定 |
| 錯誤處理 | ✅ 已實施 | ⭐⭐⭐⭐ | API 錯誤不會洩露敏感資訊 |

**改進建議：**
- [ ] 為 API 路由添加身份驗證中間件
- [ ] 實施 API 速率限制 (Rate Limiting)
- [ ] 添加 API 請求日誌記錄
- [ ] 實施 API 版本控制

---

## 🌐 4. 前端安全 (Frontend Security)

| 項目 | 狀態 | 評級 | 說明 |
|------|------|------|------|
| XSS 防護 | ⚠️ 部分實施 | ⭐⭐⭐ | React 自動轉義，但需加強輸入驗證 |
| CSRF 防護 | ⚠️ 部分實施 | ⭐⭐⭐ | Supabase 內建 CSRF Token |
| 輸入驗證 | ⚠️ 部分實施 | ⭐⭐⭐ | 基本驗證存在，但需加強 |
| 敏感資料暴露 | ✅ 已實施 | ⭐⭐⭐⭐ | 環境變數正確使用，API Key 不暴露 |
| 客戶端儲存 | ⚠️ 需審查 | ⭐⭐⭐ | 使用 localStorage，需確認敏感資料 |
| Content Security Policy | ❌ 未實施 | ⭐⭐ | 無 CSP 標頭設定 |

**改進建議：**
- [ ] 實施完整的輸入驗證和清理
- [ ] 添加 Content Security Policy (CSP)
- [ ] 審查 localStorage 使用，避免儲存敏感資料
- [ ] 實施客戶端輸入長度限制
- [ ] 添加檔案上傳大小和類型驗證

---

## 📝 5. 資料驗證與清理 (Data Validation & Sanitization)

| 項目 | 狀態 | 評級 | 說明 |
|------|------|------|------|
| 前端驗證 | ⚠️ 部分實施 | ⭐⭐⭐ | 基本驗證存在（必填、數字格式等） |
| 後端驗證 | ⚠️ 部分實施 | ⭐⭐⭐ | Supabase 表結構限制，但需加強 |
| SQL 注入防護 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | Supabase 參數化查詢 |
| 檔案上傳驗證 | ⚠️ 部分實施 | ⭐⭐⭐ | Excel 檔案大小限制，但需加強類型驗證 |
| 資料清理 | ❌ 未實施 | ⭐⭐ | 無資料清理機制 |

**改進建議：**
- [ ] 實施完整的輸入驗證庫（如 Zod、Yup）
- [ ] 添加檔案類型白名單驗證
- [ ] 實施資料清理和正規化
- [ ] 添加惡意檔案檢測

---

## 🔐 6. 敏感資料保護 (Sensitive Data Protection)

| 項目 | 狀態 | 評級 | 說明 |
|------|------|------|------|
| 環境變數管理 | ✅ 已實施 | ⭐⭐⭐⭐ | 正確使用環境變數 |
| API Key 保護 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | Google API Key 在伺服器端 |
| 密碼儲存 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | Supabase 使用 bcrypt 加密 |
| 資料傳輸加密 | ✅ 已實施 | ⭐⭐⭐⭐⭐ | HTTPS/TLS 加密 |
| 日誌敏感資訊 | ✅ 已實施 | ⭐⭐⭐⭐ | API Key 在日誌中被遮蔽 |

**改進建議：**
- [ ] 實施資料加密 (Encryption at Rest)
- [ ] 定期輪換 API Key
- [ ] 審查所有日誌輸出，確保不洩露敏感資訊

---

## 📊 7. 日誌與監控 (Logging & Monitoring)

| 項目 | 狀態 | 評級 | 說明 |
|------|------|------|------|
| 應用程式日誌 | ⚠️ 部分實施 | ⭐⭐⭐ | 使用 console.log，但無集中式日誌 |
| 錯誤追蹤 | ❌ 未實施 | ⭐⭐ | 無錯誤追蹤系統（如 Sentry） |
| 安全事件記錄 | ❌ 未實施 | ⭐⭐ | 無安全事件記錄 |
| 效能監控 | ❌ 未實施 | ⭐⭐ | 無效能監控 |

**改進建議：**
- [ ] 實施集中式日誌系統
- [ ] 整合錯誤追蹤服務（如 Sentry）
- [ ] 記錄所有安全相關事件（登入失敗、權限拒絕等）
- [ ] 實施效能監控和告警

---

## 🚨 8. 安全漏洞與風險 (Security Vulnerabilities & Risks)

### 高風險項目
1. **API 路由未驗證身份** ⚠️
   - **風險：** Google Sheets API 路由未驗證用戶身份
   - **影響：** 未授權用戶可能存取 API
   - **建議：** 添加身份驗證中間件

2. **無速率限制** ⚠️
   - **風險：** API 可能遭受 DDoS 攻擊
   - **影響：** 服務可能被癱瘓
   - **建議：** 實施 API 速率限制

### 中風險項目
1. **輸入驗證不足** ⚠️
   - **風險：** 可能導致 XSS 或資料注入
   - **影響：** 資料完整性受損
   - **建議：** 實施完整的輸入驗證

2. **無 Content Security Policy** ⚠️
   - **風險：** XSS 攻擊風險增加
   - **影響：** 客戶端安全受威脅
   - **建議：** 實施 CSP 標頭

3. **無錯誤追蹤** ⚠️
   - **風險：** 無法及時發現安全問題
   - **影響：** 安全事件可能被忽略
   - **建議：** 整合錯誤追蹤系統

### 低風險項目
1. **無雙因素認證** ℹ️
   - **風險：** 帳號被盜用風險
   - **影響：** 中等
   - **建議：** 考慮實施 2FA

---

## ✅ 9. 已實施的安全措施總結

### 優秀實施項目
- ✅ Supabase Auth 認證系統
- ✅ Row Level Security (RLS) 完整實施
- ✅ 角色基礎存取控制 (RBAC)
- ✅ API Key 正確保護（伺服器端）
- ✅ 資料庫連線加密
- ✅ SQL 注入防護
- ✅ 單一裝置登入機制
- ✅ 多分頁檢測

### 良好實施項目
- ✅ 基本輸入驗證
- ✅ 環境變數管理
- ✅ 檔案上傳大小限制
- ✅ 錯誤處理機制

---

## 📋 10. 優先改進建議（依重要性排序）

### 🔴 高優先級（立即處理）
1. **為 API 路由添加身份驗證**
   - 檔案：`src/app/api/google-sheets/route.ts`
   - 實施 Supabase 身份驗證中間件

2. **實施 API 速率限制**
   - 使用 Vercel Edge Middleware 或 Next.js Middleware
   - 限制每 IP 每分鐘請求次數

3. **加強輸入驗證**
   - 整合驗證庫（如 Zod）
   - 驗證所有用戶輸入

### 🟡 中優先級（近期處理）
4. **實施 Content Security Policy**
   - 在 `next.config.mjs` 中添加 CSP 標頭

5. **整合錯誤追蹤系統**
   - 整合 Sentry 或其他錯誤追蹤服務

6. **實施安全事件記錄**
   - 記錄所有登入失敗、權限拒絕等事件

### 🟢 低優先級（長期規劃）
7. **實施雙因素認證 (2FA)**
8. **實施資料加密 (Encryption at Rest)**
9. **定期安全審計**
10. **實施效能監控**

---

## 📈 11. 合規性檢查

| 標準 | 符合度 | 說明 |
|------|--------|------|
| OWASP Top 10 | 70% | 主要項目已實施，需加強輸入驗證和監控 |
| GDPR | 60% | 基本資料保護，需加強資料加密和審計 |
| ISO 27001 | 50% | 基本安全措施，需完整的安全管理體系 |

---

## 📝 12. 結論

**整體評估：**
工廠排程系統 APS 已實施了主要的安全措施，包括：
- 完整的認證與授權系統
- 資料庫層級的安全控制
- 基本的 API 和前端安全措施

**主要優勢：**
- ✅ 使用 Supabase 提供的安全基礎設施
- ✅ RLS 政策完整且基於角色
- ✅ API Key 正確保護

**需要改進：**
- ⚠️ API 路由身份驗證
- ⚠️ 輸入驗證和清理
- ⚠️ 監控和日誌系統

**建議行動：**
1. 立即處理高優先級項目（API 身份驗證、速率限制）
2. 近期實施中優先級項目（CSP、錯誤追蹤）
3. 長期規劃低優先級項目（2FA、資料加密）

---

**評估人員：** AI Assistant  
**下次評估日期：** 建議 3 個月後或重大更新後
