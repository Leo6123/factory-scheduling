# 多設備認證說明

## 問題

如果不同用戶在不同電腦上使用，但都使用相同的瀏覽器（例如都使用 Chrome），是否會有干擾或無法登錄的問題？

## 答案：**完全不會有干擾** ✅

不同電腦之間是完全獨立的環境，不會互相影響。

## 詳細說明

### 1. 每台電腦是獨立的環境

- **獨立的瀏覽器實例**：每台電腦有自己的瀏覽器安裝和配置
- **獨立的存儲**：每台電腦有獨立的：
  - `sessionStorage`（關閉瀏覽器後清除）
  - `localStorage`（持久存儲）
  - Cookies
- **獨立的網路連接**：每台電腦有不同的 IP 地址
- **獨立的硬體**：不同的 CPU、記憶體、硬碟

### 2. Supabase 認證機制

Supabase 的認證是基於 **JWT (JSON Web Token)** 的：

- **每個設備有獨立的 session token**：
  - 用戶 A 在電腦 1 登入 → 獲得 token A1
  - 用戶 A 在電腦 2 登入 → 獲得 token A2（不同的 token）
  - 用戶 B 在電腦 3 登入 → 獲得 token B3（完全獨立的 token）

- **伺服器端驗證**：
  - Supabase 伺服器驗證每個 token 的有效性
  - 不同設備的 token 不會互相影響
  - 每個 token 都是獨立的

- **用戶資料獨立**：
  - 每個用戶在 `user_profiles` 表中有獨立的記錄
  - 用戶 A 和用戶 B 的資料完全分離

### 3. Session 存儲

系統使用 `sessionStorage` 存儲 session：

- **每台電腦的 sessionStorage 完全獨立**
- 電腦 1 的 sessionStorage 不會影響電腦 2
- 當用戶在電腦 1 登入時，只會影響電腦 1 的 sessionStorage

### 4. 多分頁檢測機制

系統的多分頁檢測使用 `BroadcastChannel`：

- **BroadcastChannel 只在同一瀏覽器會話內工作**
- 只在**同一台電腦的同一瀏覽器的不同分頁之間**傳播消息
- 不同電腦的瀏覽器**無法互相通信**

## 使用場景對照表

| 場景 | 是否會有干擾 | 說明 |
|------|------------|------|
| **不同電腦，不同用戶** | ❌ **不會** | 完全獨立的環境，不會影響 |
| **不同電腦，同一用戶** | ❌ **不會** | 不同設備的 session 獨立，可以同時登入 |
| **同一電腦，不同分頁，不同用戶** | ⚠️ **可能會有** | 同一瀏覽器的不同分頁可能共享 sessionStorage（取決於瀏覽器實現） |
| **同一電腦，同一分頁，不同用戶** | ✅ **不會** | 需要先登出再登入，順序使用 |
| **同一電腦，同一分頁，同一用戶** | ✅ **正常** | 單一登入，正常工作 |

## 實際使用範例

### 場景 1：辦公室環境

- **電腦 1**：用戶 `leo.chang@avient.com` 登入 → ✅ 正常工作
- **電腦 2**：用戶 `cti912@hotmail.com` 登入 → ✅ 正常工作
- **電腦 3**：用戶 `operator@factory.com` 登入 → ✅ 正常工作

**結果**：所有電腦同時正常工作，互不干擾 ✅

### 場景 2：同一用戶在不同設備

- **辦公室電腦**：`leo.chang@avient.com` 登入 → ✅ 正常工作
- **筆記本電腦**：`leo.chang@avient.com` 登入 → ✅ 正常工作
- **手機瀏覽器**：`leo.chang@avient.com` 登入 → ✅ 正常工作

**結果**：同一用戶可以在多個設備同時登入，互不干擾 ✅

### 場景 3：同一電腦，不同分頁，不同用戶

- **分頁 1**：`leo.chang@avient.com` 登入
- **分頁 2**：`cti912@hotmail.com` 登入

**結果**：可能會有問題（取決於瀏覽器實現），建議使用不同的瀏覽器 Profile 或無痕模式 ⚠️

## 建議

### 對於不同電腦的使用者

✅ **完全不需要擔心**：
- 每台電腦是獨立的環境
- 不會互相影響
- 可以同時使用，正常工作

### 對於同一台電腦的使用者

⚠️ **需要注意**：
- 如果要在同一台電腦上使用不同帳號，建議：
  1. 使用不同的瀏覽器 Profile（推薦）
  2. 使用無痕模式
  3. 使用不同的瀏覽器（Chrome、Firefox、Edge）
  4. 順序使用（先登出，再登入另一個帳號）

## 技術細節

### Supabase Session 管理

```typescript
// 每台電腦的 Supabase 客戶端是完全獨立的
const supabase = createClient(url, key, {
  auth: {
    storage: createCustomStorage() // 每台電腦有獨立的 sessionStorage
  }
});
```

### Session Token 格式

```
sb-<project-ref>-auth-token
```

- 每台電腦存儲的 token 值不同
- 即使 key 名稱相同，值也是獨立的
- Token 包含用戶資訊和 session ID
- 伺服器端驗證每個 token 的有效性

## 總結

- ✅ **不同電腦之間完全獨立**，不會有干擾
- ✅ **可以同時使用**，正常工作
- ✅ **每個用戶的資料獨立**，不會混亂
- ⚠️ **同一電腦的不同分頁**可能會有問題，建議使用不同的瀏覽器 Profile

---

**結論**：如果您擔心不同電腦上的用戶會互相干擾，完全不需要擔心！每台電腦是完全獨立的環境。
