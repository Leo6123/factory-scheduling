# 密碼安全性說明

## ⚠️ 重要：不要存儲明文密碼

**強烈不建議**在資料庫中存儲使用者的密碼（無論是明文還是加密形式）。

## 為什麼不能存儲密碼？

### 1. 安全風險

- **資料洩露風險**：如果資料庫被攻擊，所有使用者的密碼都會被洩露
- **違反安全原則**：違反了「不應該以任何形式存儲密碼」的基本安全原則
- **法律責任**：如果發生資料洩露，可能承擔法律責任
- **信任問題**：使用者不會信任存儲他們密碼的系統

### 2. 技術問題

- **Supabase Auth 使用加密存儲**：Supabase 已經使用 bcrypt 等安全演算法加密存儲密碼
- **無法解密**：即使存儲了，也無法解密查看原始密碼
- **密碼雜湊不可逆**：正確的密碼存儲方式是不可逆的雜湊，無法還原

## ✅ 正確的解決方案：使用 Supabase 密碼重置功能

### 方案 1：使用 Supabase 的密碼重置功能（推薦）

Supabase 提供了完整的密碼重置流程：

1. **使用者忘記密碼時**：
   - 點擊「忘記密碼」連結
   - 輸入 email
   - Supabase 會發送包含重置連結的 email

2. **使用者收到 email**：
   - 點擊重置連結
   - 設置新密碼

3. **優點**：
   - ✅ 安全：密碼不會被存儲或洩露
   - ✅ 符合安全標準
   - ✅ Supabase 自動處理
   - ✅ 包含安全驗證（token、過期時間等）

### 方案 2：管理員重置密碼（需要實作）

如果管理員需要直接重置使用者密碼，可以使用 Supabase Admin API：

1. **使用 Supabase Admin API**：
   - 只有管理員可以訪問
   - 可以生成臨時密碼或重置連結
   - 不需要知道原始密碼

2. **實作步驟**：
   - 建立管理員專用的 API Route（Next.js）
   - 使用 Supabase Admin API 重置密碼
   - 將臨時密碼或重置連結發送給使用者

## 📋 建議的工作流程

### 場景：使用者忘記密碼

**當前工作流程（如果使用密碼重置功能）**：

1. 使用者點擊「忘記密碼」
2. 輸入 email
3. 收到重置 email
4. 點擊連結，設置新密碼
5. 完成

**時間**：約 2-5 分鐘

---

**如果存儲密碼的工作流程（不推薦）**：

1. 使用者聯繫管理員
2. 管理員查詢資料庫
3. 告訴使用者密碼
4. 使用者登入

**時間**：可能更快，但**不安全**

---

### 更好的工作流程

**建議**：實作管理員重置密碼功能

1. 使用者聯繫管理員（例如：透過 email 或內部系統）
2. 管理員使用管理介面重置密碼
3. 系統生成臨時密碼或重置連結
4. 系統自動發送 email 給使用者
5. 使用者使用臨時密碼登入或點擊連結設置新密碼

**優點**：
- ✅ 安全：不需要存儲密碼
- ✅ 快速：管理員可以快速重置
- ✅ 符合安全標準
- ✅ 包含審計日誌（可以記錄誰重置了誰的密碼）

## 🔧 實作建議

### 選項 1：啟用 Supabase 密碼重置功能（最簡單）

在 Supabase Dashboard 中：
1. 前往 **Authentication** > **URL Configuration**
2. 設置 **Site URL** 和 **Redirect URLs**
3. 在 **Email Templates** 中配置密碼重置 email 模板
4. 在前端添加「忘記密碼」連結

### 選項 2：實作管理員重置密碼功能（推薦）

1. **建立管理員 API Route**：
   ```typescript
   // src/app/api/admin/reset-password/route.ts
   import { createClient } from '@supabase/supabase-js';
   
   export async function POST(request: Request) {
     // 檢查管理員權限
     // 使用 Supabase Admin API 重置密碼
     // 發送 email 給使用者
   }
   ```

2. **建立管理員介面**：
   - 只有管理員可以訪問
   - 可以搜尋使用者
   - 可以重置密碼
   - 記錄操作日誌

## 📝 替代方案：臨時密碼系統（不推薦存儲原始密碼）

如果確實需要快速告知密碼的功能（例如：新使用者首次登入），可以考慮：

### 方案 A：初始密碼系統

1. **建立使用者時**：
   - 使用 Supabase Admin API 建立使用者
   - 設置臨時密碼
   - 將臨時密碼存儲在 `user_profiles` 表中的 `temp_password` 欄位（加密）
   - 發送 email 給使用者

2. **使用者首次登入**：
   - 使用臨時密碼登入
   - 系統強制更改密碼
   - 清除 `temp_password`

3. **注意**：
   - 只有臨時密碼才存儲（且加密）
   - 使用者更改密碼後，不再存儲
   - 仍然不如密碼重置功能安全

### 方案 B：密碼提示系統（不推薦）

1. 要求使用者設置密碼提示問題
2. 如果忘記密碼，回答問題後重置

**缺點**：安全性較低，不推薦

## 🚫 絕對不要做的事

1. ❌ **不要存儲明文密碼**
2. ❌ **不要將密碼存儲在可查詢的資料表中**
3. ❌ **不要將密碼發送給使用者（除非是臨時密碼且加密）**
4. ❌ **不要告訴使用者他們的密碼（即使是「友善」的目的）**

## ✅ 推薦做法總結

1. **使用 Supabase 密碼重置功能**（最安全、最簡單）
2. **如果管理員需要重置密碼**：實作管理員重置功能（使用 Admin API）
3. **如果新使用者首次登入**：使用臨時密碼系統（使用後清除）
4. **記錄所有密碼重置操作**（審計日誌）

## 📚 相關資源

- [Supabase 密碼重置文檔](https://supabase.com/docs/guides/auth/password-reset)
- [Supabase Admin API](https://supabase.com/docs/reference/javascript/admin-api)
- [OWASP 密碼存儲建議](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)

---

## 結論

**不要存儲使用者的密碼**，即使是在「友善」的用途下。使用 Supabase 的密碼重置功能或管理員重置功能，這樣更安全、更符合標準，也能保護使用者和系統的安全。
