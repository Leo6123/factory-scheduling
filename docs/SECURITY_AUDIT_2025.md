# 資安風險評估報告 2025

## 📋 執行日期
2025年1月11日

## 🔍 檢查範圍
- 身份驗證和授權
- Row Level Security (RLS) 政策
- API 安全
- 客戶端安全
- 會話管理
- 敏感資料處理
- 環境變數管理
- 輸入驗證
- XSS 和 SQL 注入防護
- 密碼重置流程
- Viewer 權限實現

---

## 🚨 嚴重安全問題

### 1. **RLS 政策可能未正確實施** ⚠️ **高風險**

**問題**：
- 雖然有 `supabase_secure_rls_policies.sql` 文件，但需要確認是否已在 Supabase 中執行
- 如果 RLS 政策未正確實施，viewer 用戶可能仍可以通過直接調用 Supabase API 來修改或刪除資料

**影響**：
- Viewer 用戶可以繞過前端權限檢查
- 任何已登入用戶都可以刪除所有排程資料
- 權限控制完全依賴前端，不安全

**修復建議**：
1. 確認 `supabase_secure_rls_policies.sql` 已在 Supabase 中執行
2. 測試 viewer 用戶是否真的無法通過 Supabase API 修改資料
3. 驗證 RLS 政策是否正確檢查 `get_user_role_safe()` 函數

**優先級**：🔴 **高（立即修復）**

---

### 2. **Google API Key 暴露在客戶端** ⚠️ **中-高風險**

**問題**：
- `NEXT_PUBLIC_GOOGLE_API_KEY` 暴露在客戶端代碼中
- 任何人都可以從瀏覽器開發工具或源代碼中獲取 API Key
- 在 `src/components/Swimlane.tsx` 和 `src/components/BatchSearch.tsx` 中直接使用

**影響**：
- API Key 可能被濫用
- 可能產生額外的 API 費用
- 如果 API Key 有寫入權限，可能被惡意修改 Google Sheets

**修復建議**：
1. **最佳方案**：將 Google Sheets API 調用移到 Next.js API Routes（伺服器端）
2. **次佳方案**：限制 API Key 的權限（僅允許特定域名使用）
3. **臨時方案**：使用 Google Service Account 進行伺服器端認證

**優先級**：🟡 **中-高（盡快修復）**

---

### 3. **缺少輸入驗證** ⚠️ **中風險**

**問題**：
- 用戶輸入（數量、日期、批號等）直接保存到資料庫，沒有驗證格式和範圍
- 雖然使用 Supabase 的查詢構建器（有 SQL 注入防護），但缺少業務邏輯驗證

**影響**：
- 可能保存無效或惡意資料
- 可能導致資料不一致
- 可能導致系統錯誤

**修復建議**：
1. 添加輸入驗證：
   - 數量：必須是正數，範圍檢查（例如：0-1000000）
   - 日期：格式驗證（YYYY-MM-DD）
   - 批號：格式驗證（白名單或正則表達式）
   - 產線 ID：白名單驗證（只允許有效的產線 ID）
2. 在資料庫層添加 CHECK 約束
3. 使用 TypeScript 類型檢查

**優先級**：🟡 **中（盡快修復）**

---

## ⚠️ 中等安全問題

### 4. **過多的調試日誌** ⚠️ **低-中風險**

**問題**：
- 代碼中有大量 `console.log` 語句（357 個匹配）
- 可能洩露敏感信息（用戶 ID、email、資料庫查詢等）
- 在生產環境中應該移除或使用日誌級別控制

**影響**：
- 敏感信息可能被洩露
- 增加攻擊面
- 影響性能（大量日誌輸出）

**修復建議**：
1. 移除不必要的 `console.log`
2. 使用環境變數控制日誌級別（開發環境 vs 生產環境）
3. 使用專業的日誌庫（例如：winston、pino）
4. 確保生產環境不輸出敏感信息

**優先級**：🟡 **中（建議修復）**

---

### 5. **會話過期時間未明確設定** ⚠️ **低-中風險**

**問題**：
- Supabase session 的過期時間使用默認值
- 沒有明確設定 session 過期時間
- 使用 `sessionStorage`（關閉瀏覽器後清除），但沒有設定最大存活時間

**影響**：
- Session 可能過期時間過長，增加安全風險
- 如果 session 洩露，攻擊者有更多時間利用

**修復建議**：
1. 設定合理的 session 過期時間（例如：24 小時）
2. 實現自動刷新機制
3. 在 Supabase Dashboard 中設定 session 過期時間

**優先級**：🟡 **中（建議修復）**

---

### 6. **缺少操作日誌記錄** ⚠️ **低-中風險**

**問題**：
- 沒有記錄重要操作（例如：刪除、修改排程項目）
- 無法追蹤誰做了什麼操作
- 無法進行安全審計

**影響**：
- 無法追蹤惡意操作
- 無法進行安全審計
- 無法恢復被誤刪的資料

**修復建議**：
1. 建立操作日誌表（`audit_logs`）
2. 記錄重要操作：
   - 刪除排程項目
   - 修改排程項目
   - 匯入/匯出資料
   - 清除全部資料
3. 記錄操作者、時間、操作類型、操作內容

**優先級**：🟡 **中（建議修復）**

---

### 7. **密碼重置流程的安全性** ⚠️ **低-中風險**

**問題**：
- 密碼重置流程依賴 Supabase 的內建機制，這是好的
- 但缺少額外的安全措施（例如：rate limiting、email 驗證）

**影響**：
- 可能被濫用進行 email 探測
- 可能被用於 DoS 攻擊（發送大量重置郵件）

**修復建議**：
1. 實施 rate limiting（限制每個 IP 的重置請求次數）
2. 添加 CAPTCHA（防止自動化攻擊）
3. 記錄重置請求（用於安全審計）

**優先級**：🟡 **中（建議修復）**

---

## ✅ 已實施的安全措施

### 1. **身份驗證** ✅
- 使用 Supabase Auth 進行身份驗證
- 密碼登入已實施
- Session 管理使用 sessionStorage（關閉瀏覽器後清除）
- 密碼重置流程已實施

### 2. **路由保護** ✅
- 使用 `ProtectedRoute` 組件保護需要登入的頁面
- 未登入用戶會自動重定向到登入頁

### 3. **SQL 注入防護** ✅
- 使用 Supabase 的查詢構建器，有內建的 SQL 注入防護
- 沒有直接執行 SQL 語句

### 4. **環境變數管理** ✅
- `.env.local` 已添加到 `.gitignore`
- 敏感資訊不會提交到版本控制

### 5. **單裝置登入** ✅
- 實現了單裝置登入機制
- 多分頁檢測和強制登出

### 6. **Session 持久化** ✅
- 使用 sessionStorage（關閉瀏覽器後清除）
- 每個分頁有獨立的 session（允許不同帳號同時登入）

### 7. **Viewer 權限實現** ✅
- 前端權限檢查已實施
- Viewer 無法編輯、刪除、匯入、匯出
- 左側邊欄和配方列表已隱藏

### 8. **Email 探測防護** ✅
- 密碼重置流程中，即使 email 不存在也顯示成功訊息
- 防止攻擊者探測哪些 email 已註冊

---

## 📊 安全評分

| 項目 | 評分 | 說明 |
|------|------|------|
| 身份驗證 | 🟢 **良好** | Supabase Auth，sessionStorage |
| 授權（RLS） | 🟡 **需要確認** | 有政策文件，但需要確認是否已實施 |
| API 安全 | 🟡 **中等** | Google API Key 暴露，缺少伺服器端驗證 |
| 輸入驗證 | 🟡 **中等** | 缺少驗證和清理 |
| Session 管理 | 🟢 **良好** | sessionStorage + 單裝置登入 |
| 資料保護 | 🟡 **中等** | RLS 政策需要確認 |
| 環境變數 | 🟢 **良好** | 已正確管理 |
| 日誌管理 | 🟡 **中等** | 過多調試日誌 |
| 操作審計 | 🔴 **不足** | 缺少操作日誌記錄 |
| XSS 防護 | 🟢 **良好** | React 自動轉義，沒有使用 dangerouslySetInnerHTML |
| SQL 注入防護 | 🟢 **良好** | 使用 Supabase 查詢構建器 |

**總體評分**：🟡 **中等（需要改進）**

---

## 🔧 立即需要修復的問題

### 優先級 1（高風險 - 立即修復）

1. **確認 RLS 政策已正確實施**
   - 在 Supabase SQL Editor 中執行 `supabase_secure_rls_policies.sql`
   - 測試 viewer 用戶是否真的無法通過 Supabase API 修改資料
   - 驗證 RLS 政策是否正確檢查用戶角色

2. **移動 Google API Key 到伺服器端**
   - 建立 Next.js API Routes 處理 Google Sheets API 調用
   - 將 API Key 移到伺服器端環境變數

### 優先級 2（中風險 - 盡快修復）

3. **添加輸入驗證**
   - 驗證日期格式、數量範圍、產線 ID 等
   - 在資料庫層添加 CHECK 約束

4. **清理調試日誌**
   - 移除不必要的 `console.log`
   - 使用環境變數控制日誌級別

5. **添加操作日誌記錄**
   - 建立 `audit_logs` 表
   - 記錄重要操作

### 優先級 3（低風險 - 建議修復）

6. **設定 Session 過期時間**
   - 明確設定 session 過期時間

7. **添加 Rate Limiting**
   - 限制登入和密碼重置請求的頻率

---

## 📝 詳細檢查結果

### 認證和授權

**✅ 優點**：
- 使用 Supabase Auth 進行身份驗證
- 實現了基於角色的權限控制（admin/operator/viewer）
- 前端權限檢查已實施

**⚠️ 問題**：
- 需要確認 RLS 政策是否已正確實施
- 如果 RLS 政策未實施，viewer 用戶可以繞過前端限制

### 資料庫安全

**✅ 優點**：
- 有 `supabase_secure_rls_policies.sql` 文件
- 使用 `get_user_role_safe()` 函數檢查用戶角色

**⚠️ 問題**：
- 需要確認 RLS 政策是否已在 Supabase 中執行
- 需要測試政策是否正確工作

### API 安全

**✅ 優點**：
- 使用 Supabase 的查詢構建器（有 SQL 注入防護）
- 沒有直接執行 SQL 語句

**⚠️ 問題**：
- Google API Key 暴露在客戶端
- 缺少伺服器端 API 路由

### 輸入驗證

**⚠️ 問題**：
- 缺少輸入驗證
- 用戶輸入直接保存到資料庫
- 沒有驗證格式和範圍

### XSS 防護

**✅ 優點**：
- 使用 React（自動轉義）
- 沒有使用 `dangerouslySetInnerHTML`
- 沒有使用 `eval()` 或 `Function()`

### 會話管理

**✅ 優點**：
- 使用 sessionStorage（關閉瀏覽器後清除）
- 實現了單裝置登入機制
- 多分頁檢測和強制登出

**⚠️ 問題**：
- Session 過期時間未明確設定

### 密碼重置

**✅ 優點**：
- 使用 Supabase 的內建密碼重置功能
- 實施了 email 探測防護
- Token 驗證由 Supabase 處理

**⚠️ 問題**：
- 缺少 rate limiting
- 缺少 CAPTCHA

---

## 🔒 安全最佳實踐建議

1. **最小權限原則**：用戶只應該有完成工作所需的最小權限 ✅（已實施）
2. **深度防禦**：不要只依賴前端權限檢查，後端也要驗證 ⚠️（需要確認 RLS）
3. **定期審計**：定期檢查和更新安全政策 ⚠️（缺少操作日誌）
4. **監控和日誌**：記錄重要操作，監控異常行為 ⚠️（缺少操作日誌）
5. **資料備份**：定期備份資料，以防資料被惡意刪除 ⚠️（需要確認）

---

## 📚 相關文件

- `docs/SECURITY_AUDIT_REPORT.md` - 之前的資安審計報告
- `supabase_secure_rls_policies.sql` - 安全強化的 RLS 政策
- `src/types/auth.ts` - 權限定義
- `src/contexts/AuthContext.tsx` - 身份驗證上下文

---

## ✅ 下一步行動

1. [ ] **確認 RLS 政策已正確實施**（優先級 1）
2. [ ] **測試 viewer 用戶是否真的無法通過 Supabase API 修改資料**（優先級 1）
3. [ ] **移動 Google API Key 到伺服器端**（優先級 1）
4. [ ] **添加輸入驗證**（優先級 2）
5. [ ] **清理調試日誌**（優先級 2）
6. [ ] **添加操作日誌記錄**（優先級 2）
7. [ ] **設定 Session 過期時間**（優先級 3）
8. [ ] **添加 Rate Limiting**（優先級 3）
