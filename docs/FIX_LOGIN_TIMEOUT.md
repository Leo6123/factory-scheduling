# 修復登入超時問題

## 問題描述

登入時出現「身份驗證初始化超時(15秒)」錯誤，導致無法登入。

## 根本原因

1. **初始化流程阻塞**：`updateUser()` 需要查詢資料庫獲取用戶角色，如果查詢慢會導致整體初始化超時
2. **超時時間過短**：15 秒的總超時時間不足以應付網路慢或資料庫慢的情況
3. **登入流程阻塞**：登入時也會等待角色查詢完成，導致登入按鈕一直顯示「登入中...」

## 修復方案

### 1. 非阻塞初始化（已修復）

**修改前**：初始化時等待 `updateUser()` 完成才設定 `loading = false`

**修改後**：
- 立即設定 session 和基本用戶信息（使用默認角色 `operator`）
- 立即停止 loading，讓用戶可以進入系統
- 在**後台異步**獲取正確的角色，完成後再更新

**好處**：
- 用戶可以立即登入，不需要等待角色查詢
- 即使角色查詢失敗，用戶仍然可以使用系統（使用默認角色）
- 角色查詢完成後會自動更新顯示

### 2. 非阻塞登入流程（已修復）

**修改前**：登入時等待 `updateUser()` 完成才返回成功

**修改後**：
- 登入成功後立即設定 session 和基本用戶信息
- 立即停止 loading，讓登入流程完成
- 在後台異步獲取正確的角色

**好處**：
- 登入按鈕不會一直顯示「登入中...」
- 登入流程快速完成
- 角色信息稍後會自動更新

### 3. 延長總超時時間（已修復）

**修改前**：15 秒總超時

**修改後**：30 秒總超時（給足夠時間完成所有操作）

### 4. 優化設備 Session 註冊（已修復）

**修改前**：無超時保護，可能一直等待

**修改後**：5 秒超時保護，如果超時或函數不存在，跳過（降級處理）

## 使用說明

### 正常登入流程

1. **輸入帳號密碼**，點擊「登入」
2. **登入立即完成**（不等待角色查詢）
3. **進入系統**（可能暫時顯示「操作員」）
4. **1-2 秒後**角色會自動更新為正確的角色（如「管理員」）

### 如果仍然超時

如果仍然看到超時錯誤，請檢查：

1. **Supabase 連接狀態**
   - 打開開發者工具 > Network
   - 檢查是否有對 Supabase 的請求失敗

2. **資料庫查詢速度**
   - 執行 `supabase_complete_fix.sql` 來優化索引
   - 檢查 RLS 政策是否正確設置

3. **網路連接**
   - 檢查網路速度
   - 嘗試重新整理頁面

## 技術細節

### 修改的文件

- `src/contexts/AuthContext.tsx`
  - 修改 `useEffect` 初始化邏輯（非阻塞）
  - 修改 `signIn` 函數（非阻塞）
  - 延長總超時時間（15秒 → 30秒）
  - 優化設備 session 註冊（添加超時保護）

### 關鍵代碼片段

```typescript
// 初始化時立即設定基本信息，不等待角色查詢
setSession(session);
setUser({
  id: session.user.id,
  email: session.user.email || '',
  role: 'operator', // 臨時使用默認角色
  createdAt: session.user.created_at,
});
setLoading(false); // 立即停止 loading

// 在後台異步更新角色（不阻塞 UI）
getUserRole(session.user)
  .then((role) => {
    if (mounted) {
      setUser(prev => prev ? { ...prev, role } : null);
    }
  })
  .catch((err) => {
    // 保持默認角色，不影響用戶使用
  });
```

## 測試步驟

1. **清除瀏覽器緩存**（`Ctrl+Shift+Del`）
2. **重新整理頁面**（`Ctrl+Shift+R`）
3. **輸入帳號密碼登入**
4. **確認**：
   - 登入按鈕不會一直顯示「登入中...」
   - 登入成功後立即進入系統
   - 右上角可能暫時顯示「操作員」，但會在 1-2 秒後更新為正確角色（如「管理員」）

## 已知限制

- 角色更新是**異步的**，會有短暫延遲（1-2 秒）
- 如果角色查詢失敗，會使用默認角色 `operator`（不影響系統使用）

## 後續優化建議

1. **添加角色查詢快取**：成功查詢後快取 5 分鐘，減少資料庫查詢
2. **顯示載入狀態**：在角色更新時顯示一個小的載入指示器
3. **錯誤提示**：如果角色查詢失敗，顯示友好的提示訊息
