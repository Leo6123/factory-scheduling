# 併發編輯說明

## 問題

如果兩個操作員（operator）同時使用，或再加入管理員（共三位）同時在線編輯，會如何？

## 當前系統行為

### ✅ 支援的功能

1. **即時同步（Realtime Sync）**
   - 系統使用 Supabase Realtime 監聽 `schedule_items` 表的變更
   - 當任何用戶進行 INSERT/UPDATE/DELETE 操作時，所有其他用戶會在 **1-2 秒內**自動收到通知
   - 所有用戶的畫面會自動更新，顯示最新的資料

2. **多用戶同時編輯**
   - 系統支援多個用戶同時在線編輯
   - 不同用戶可以編輯不同的排程項目，互不干擾
   - 每個用戶的操作都會自動同步到所有其他用戶

### ⚠️ 限制和注意事項

#### 1. 衝突處理機制（Last Write Wins）

當**多個用戶同時編輯同一個排程項目**時：

- **機制**：使用 `upsert` 操作，`onConflict: 'id'`
- **行為**：**最後寫入的用戶會覆蓋先寫入的用戶的變更**（Last Write Wins）
- **風險**：**可能會丟失資料**，因為先寫入的變更會被覆蓋，沒有警告或提示

#### 2. 具體場景

**場景 1：不同用戶編輯不同項目** ✅ **安全**

- 用戶 A 編輯項目 1（例如：移動到 TS26 產線）
- 用戶 B 編輯項目 2（例如：移動到 27CC 產線）
- 用戶 C 編輯項目 3（例如：修改數量）

**結果**：✅ 完全正常，互不干擾，所有變更都會被保存

---

**場景 2：多個用戶同時編輯同一項目** ⚠️ **有風險**

- **時間點 1**：用戶 A 開始編輯項目 X（拖曳移動位置）
- **時間點 2**：用戶 B 同時編輯項目 X（修改數量）
- **時間點 3**：用戶 A 的變更先保存到資料庫
- **時間點 4**：用戶 B 的變更後保存到資料庫 → **覆蓋用戶 A 的變更**

**結果**：⚠️ 用戶 A 的變更（移動位置）會**丟失**，只有用戶 B 的變更（修改數量）會被保存

---

**場景 3：多個用戶同時拖曳同一項目**

- **時間點 1**：用戶 A 將項目 X 拖曳到 TS26 產線的 10:00 位置
- **時間點 2**：用戶 B 同時將項目 X 拖曳到 27CC 產線的 14:00 位置
- **時間點 3**：用戶 A 的變更先保存
- **時間點 4**：用戶 B 的變更後保存 → **覆蓋用戶 A 的變更**

**結果**：⚠️ 項目 X 最終會在 27CC 產線的 14:00 位置（用戶 B 的變更），用戶 A 的變更（TS26 產線的 10:00 位置）會**丟失**

---

**場景 3：三個用戶同時編輯**

- **用戶 A（操作員）**：編輯項目 1
- **用戶 B（操作員）**：編輯項目 2
- **用戶 C（管理員）**：編輯項目 3

**結果**：✅ **完全正常**，因為編輯的是不同的項目，互不干擾

---

- **用戶 A（操作員）**：編輯項目 X
- **用戶 B（操作員）**：同時編輯項目 X
- **用戶 C（管理員）**：同時編輯項目 X

**結果**：⚠️ **最後保存的用戶的變更會保留**，其他用戶的變更會**丟失**

## 技術細節

### 保存機制

```typescript
// useScheduleData.ts
supabase
  .from(TABLES.SCHEDULE_ITEMS)
  .upsert(dbItems, { onConflict: 'id' })
  .select();
```

- `upsert`：如果項目存在則更新，不存在則插入
- `onConflict: 'id'`：如果 ID 衝突，則更新現有記錄
- **沒有版本檢查**：不會檢查是否有其他用戶已經修改過
- **沒有樂觀鎖**：不會鎖定記錄，允許並發編輯

### Realtime 同步

```typescript
// useRealtimeSchedule.ts
supabase
  .channel('schedule_items_changes')
  .on('postgres_changes', {
    event: '*', // INSERT, UPDATE, DELETE
    schema: 'public',
    table: TABLES.SCHEDULE_ITEMS,
  }, async (payload) => {
    // 重新載入所有資料
    const { data } = await supabase
      .from(TABLES.SCHEDULE_ITEMS)
      .select('*');
    // 更新本地狀態
    onScheduleChange(items);
  })
```

- 當任何用戶修改資料時，所有其他用戶會收到通知
- 收到通知後，系統會**重新載入所有資料**，確保顯示最新的狀態
- 同步延遲：約 1-2 秒

## 使用建議

### ✅ 推薦的使用方式

1. **分工合作**：
   - 不同用戶編輯不同的排程項目
   - 例如：用戶 A 負責 TS26、27CC 產線，用戶 B 負責 TS75、HP40-1 產線

2. **溝通協調**：
   - 如果多個用戶需要編輯同一項目，先溝通協調
   - 避免同時編輯同一項目

3. **即時查看**：
   - 利用 Realtime 同步功能，即時查看其他用戶的變更
   - 如果看到其他用戶正在編輯某個項目，避免同時編輯

### ⚠️ 避免的情況

1. **不要同時編輯同一項目**：
   - 多個用戶不要同時拖曳、修改同一個排程項目
   - 可能導致資料丟失

2. **注意 Realtime 同步延遲**：
   - 變更需要 1-2 秒才會同步到其他用戶
   - 如果快速連續操作，可能看不到其他用戶的變更

## 實際使用範例

### 範例 1：三個用戶正常使用 ✅

**情況**：
- 操作員 A：編輯項目 1、2、3
- 操作員 B：編輯項目 4、5、6
- 管理員 C：編輯項目 7、8、9

**結果**：✅ 完全正常，所有變更都會被保存，互不干擾

---

### 範例 2：三個用戶編輯同一項目 ⚠️

**情況**：
- 操作員 A：將項目 X 拖曳到 TS26 產線
- 操作員 B：同時修改項目 X 的數量
- 管理員 C：同時修改項目 X 的齊料時間

**結果**：⚠️ 最後保存的用戶的變更會保留，其他用戶的變更會丟失

**建議**：先溝通協調，避免同時編輯

---

### 範例 3：不同用戶編輯不同產線 ✅

**情況**：
- 操作員 A：負責 TS26、27CC 產線的排程
- 操作員 B：負責 TS75、HP40-1 產線的排程
- 管理員 C：負責 40MAXX、50CC 產線的排程

**結果**：✅ 完全正常，完全不會有衝突

## 未來改進建議

### 短期建議（可選）

1. **添加編輯提示**：
   - 當其他用戶正在編輯某個項目時，顯示提示
   - 建議用戶避免同時編輯

2. **操作日誌**：
   - 記錄每個變更的用戶和時間
   - 幫助追蹤和排查問題

### 長期建議（如果需要）

1. **樂觀鎖（Optimistic Locking）**：
   - 在資料表中添加 `version` 欄位
   - 保存時檢查版本號，如果版本不匹配則拒絕保存

2. **衝突檢測和合併**：
   - 檢測衝突，提示用戶選擇保留哪個變更
   - 或者自動合併非衝突的變更

3. **編輯鎖定**：
   - 當用戶開始編輯某個項目時，鎖定該項目
   - 其他用戶無法同時編輯，直到第一個用戶完成

## 總結

| 場景 | 安全性 | 建議 |
|------|--------|------|
| **不同用戶編輯不同項目** | ✅ **安全** | 可以放心使用 |
| **不同用戶編輯不同產線** | ✅ **安全** | 推薦的使用方式 |
| **多個用戶同時編輯同一項目** | ⚠️ **有風險** | 避免同時編輯，先溝通協調 |
| **三個用戶正常使用（編輯不同項目）** | ✅ **安全** | 可以正常使用 |

**結論**：如果三個用戶（兩個操作員 + 一個管理員）**編輯不同的項目或不同的產線**，系統可以正常工作，沒有問題。但如果**同時編輯同一個項目**，最後保存的用戶的變更會保留，其他用戶的變更可能會丟失。
