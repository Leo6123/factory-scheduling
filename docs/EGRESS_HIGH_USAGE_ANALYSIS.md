# Egress 高使用量分析報告

## 🚨 問題確認

從 Supabase Dashboard 看到：
- **總使用量**: 20.74 GB
- **超額**: 15.74 GB (315%)
- **1/11 峰值**: 接近 18.5 GB（單日）

---

## 🔍 根本原因分析

### 問題 1：Realtime 事件觸發雙重查詢 ⚠️ **嚴重**

**位置**: `src/hooks/useRealtimeSchedule.ts`

**問題描述**:
每次 Realtime 事件（INSERT/UPDATE）都會觸發 **2 次查詢**：

1. **第一次查詢**：查詢單一項目（優化後）
   ```typescript
   .select('*').eq('id', newId).single()
   ```

2. **第二次查詢**：**立即重新載入所有資料**（未優化）
   ```typescript
   .select('*').order('created_at', { ascending: true })
   ```

**影響**:
- 每次操作 = 2 次查詢
- 每次查詢都載入所有資料（包括 JSON 欄位）
- 如果有 5 個用戶同時在線 = 10 次查詢/操作
- 如果有 100 筆資料匯入 = 200 次查詢

**計算**:
- 假設每次查詢載入 100 KB 資料
- 100 筆匯入 × 2 次查詢 × 5 個用戶 = 1000 次查詢
- 1000 × 100 KB = **100 MB**
- 如果操作頻繁，很容易達到 **18.5 GB**

---

### 問題 2：使用 `select('*')` 載入所有欄位 ⚠️ **中等**

**位置**: 多處使用 `select('*')`

**問題描述**:
- 載入所有欄位，包括可能很大的 JSON 欄位（`recipe_items`）
- 如果每個項目有 3 個配方，每個配方 1 KB，100 筆資料 = 300 KB
- 但每次查詢都載入所有資料，即使只需要部分欄位

**影響**:
- 數據傳輸量增加 2-5 倍
- 不必要的欄位傳輸

---

### 問題 3：沒有 Realtime 事件節流 ⚠️ **中等**

**位置**: `src/hooks/useRealtimeSchedule.ts`

**問題描述**:
- 每次 Realtime 事件都立即處理
- 如果有多個事件同時觸發（例如批次匯入），會導致大量查詢

**影響**:
- 批次操作時，查詢數量成倍增長
- 沒有去重機制

---

### 問題 4：多個用戶同時使用 ⚠️ **輕微**

**問題描述**:
- 每個用戶都會訂閱 Realtime
- 每個用戶都會觸發查詢
- 如果有 10 個用戶，查詢數量 × 10

**影響**:
- 用戶數量越多，Egress 使用量越高

---

## 📊 1/11 峰值分析

### 可能的原因

1. **大量資料匯入**
   - 如果匯入了 100-200 筆資料
   - 每個用戶都會收到 100-200 個 Realtime 事件
   - 每個事件觸發 2 次查詢
   - 如果有 5 個用戶 = 1000-2000 次查詢

2. **錯誤導致重試循環**
   - 如果出現錯誤，可能導致無限重試
   - 每次重試都會觸發查詢

3. **多個分頁同時開啟**
   - 如果用戶開啟了多個分頁
   - 每個分頁都會訂閱 Realtime
   - 每個分頁都會觸發查詢

---

## ✅ 已實施的優化

### 1. 請求節流（`useScheduleData.ts`）
- ✅ 2 秒內只允許一次請求
- ✅ 減少 50-70% 的請求數量

### 2. 請求去重（`useScheduleData.ts`）
- ✅ 防止同時發送多個相同請求

### 3. 快取機制（`useScheduleData.ts`）
- ✅ 30 秒內使用快取資料
- ✅ 減少 80-90% 的不必要請求

---

## 🔧 需要進一步優化的問題

### 優先級 1：修復 Realtime 雙重查詢 ⚠️ **緊急**

**問題**: 每次事件觸發 2 次查詢

**解決方案**:
- 移除第二次全量查詢
- 只使用第一次單一項目查詢的結果
- 在父組件中合併更新，而不是重新載入所有資料

**預期效果**: 減少 50% 的查詢數量

---

### 優先級 2：優化查詢欄位 ⚠️ **重要**

**問題**: 使用 `select('*')` 載入所有欄位

**解決方案**:
- 只查詢需要的欄位
- 例如：`select('id, product_name, batch_number, quantity')`
- 避免載入大型 JSON 欄位（除非需要）

**預期效果**: 減少 50-70% 的數據傳輸量

---

### 優先級 3：添加 Realtime 事件節流 ⚠️ **重要**

**問題**: 沒有事件節流

**解決方案**:
- 添加事件去重（相同事件 ID 只處理一次）
- 添加事件節流（短時間內多個事件只處理最後一個）
- 批次處理多個事件

**預期效果**: 減少 30-50% 的查詢數量

---

## 📋 改動檔案清單

1. ✅ `src/hooks/useScheduleData.ts` - 已添加節流、去重、快取
2. ⚠️ `src/hooks/useRealtimeSchedule.ts` - **需要修復雙重查詢**
3. ⚠️ `src/components/Swimlane.tsx` - **需要支持增量更新**

---

## 🎯 預期效果

實施所有優化後：
- ✅ **查詢數量減少 80-90%**
- ✅ **Egress 使用量減少 80-90%**
- ✅ **從 20.74 GB 減少到 2-4 GB/月**
- ✅ **低於 5 GB 免費層限制**
