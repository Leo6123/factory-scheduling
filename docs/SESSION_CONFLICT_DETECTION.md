# Session 衝突檢測與確認對話框

## 功能說明

當同一帳號嘗試在新分頁或從其他設備登入時，系統會自動檢測並詢問用戶是否要關閉原分頁/裝置。

## 工作流程

### 1. 同一瀏覽器的新分頁

**流程**：
1. 用戶在新分頁輸入帳號密碼
2. 系統檢查當前瀏覽器是否有該用戶的 session
3. 如果有，顯示確認對話框：
   - **標題**：檢測到現有登入
   - **訊息**：此帳號已在其他分頁登入，是否要關閉原分頁並在此處重新登入？
4. 用戶選擇：
   - **確認**：登出原分頁，新分頁登入成功
   - **取消**：取消登入，保持原分頁登入狀態

### 2. 從其他設備登入

**流程**：
1. 用戶在其他設備輸入帳號密碼
2. 系統嘗試登入
3. 登入成功後，檢查 `device_sessions` 表是否有其他設備的 session
4. 如果有，顯示確認對話框：
   - **標題**：檢測到現有登入
   - **訊息**：此帳號已在其他分頁/裝置登入，是否要關閉原分頁/裝置並在此處重新登入？
5. 用戶選擇：
   - **確認**：刪除舊 device session，新設備登入成功
   - **取消**：登出當前設備，保持原設備登入狀態

## 技術實現

### 1. 確認對話框組件

**文件**：`src/components/ConfirmDialog.tsx`

**功能**：
- 顯示警告/資訊/錯誤類型的對話框
- 支持自定義標題、訊息、按鈕文字
- 響應式設計，適配移動端

### 2. Session 檢查邏輯

**文件**：`src/contexts/AuthContext.tsx`

**函數**：
- `checkExistingSession(email: string)`: 檢查當前瀏覽器是否有該用戶的 session
- `signIn(email, password, forceLogout)`: 登入函數，支持強制登出參數

**檢查方法**：
1. **同一瀏覽器**：檢查 `supabase.auth.getSession()` 是否返回該用戶的 session
2. **其他設備**：登入成功後，查詢 `device_sessions` 表是否有其他 session

### 3. 跨分頁通信

**技術**：BroadcastChannel API

**實現**：
```typescript
// 發送強制登出消息
const channel = new BroadcastChannel('auth_logout');
channel.postMessage({ type: 'FORCE_LOGOUT', email });
channel.close();

// 監聽強制登出消息
broadcastChannel.onmessage = (event) => {
  if (event.data?.type === 'FORCE_LOGOUT') {
    // 登出當前分頁
  }
};
```

### 4. 登入頁面整合

**文件**：`src/app/login/page.tsx`

**流程**：
1. 用戶提交登入表單
2. 先檢查當前瀏覽器是否有現有 session
3. 如果沒有，嘗試登入
4. 登入成功後，檢查是否有其他設備的 session
5. 如果有任何現有 session，顯示確認對話框
6. 用戶確認後，強制登出並重新登入

## 使用說明

### 測試場景 1：同一瀏覽器的新分頁

1. **步驟 1**：在瀏覽器分頁 A 登入帳號 `leo.chang@avient.com`
2. **步驟 2**：打開新分頁 B，嘗試登入同一個帳號
3. **步驟 3**：應該看到確認對話框
4. **步驟 4**：選擇「確認」
5. **預期結果**：
   - 分頁 A 自動登出並跳轉到登入頁
   - 分頁 B 登入成功並進入系統

### 測試場景 2：從其他設備登入

1. **步驟 1**：在設備 A（如電腦）登入帳號 `leo.chang@avient.com`
2. **步驟 2**：在設備 B（如手機）嘗試登入同一個帳號
3. **步驟 3**：登入成功後，應該看到確認對話框
4. **步驟 4**：選擇「確認」
5. **預期結果**：
   - 設備 A 的 session 被刪除（下次操作時會自動登出）
   - 設備 B 登入成功並進入系統

### 測試場景 3：取消登入

1. **步驟 1**：在分頁 A 登入帳號
2. **步驟 2**：在分頁 B 嘗試登入同一個帳號
3. **步驟 3**：看到確認對話框，選擇「取消」
4. **預期結果**：
   - 分頁 B 保持登入頁面
   - 分頁 A 繼續保持登入狀態

## 已知限制

1. **其他設備檢測**：需要在登入成功後才能檢測到其他設備的 session（因為需要先登入才能查詢資料庫）
2. **即時性**：跨分頁登出有短暫延遲（依賴 BroadcastChannel 和 Supabase Auth 的同步）
3. **device_sessions 表**：如果表不存在，其他設備檢測會失敗（但不會影響登入功能）

## 後續優化建議

1. **添加設備資訊顯示**：在確認對話框中顯示原設備的資訊（如「Windows Chrome」）
2. **添加「記住選擇」選項**：允許用戶選擇是否記住「總是登出舊 session」的選擇
3. **添加登入歷史記錄**：記錄用戶的登入歷史，方便管理多設備登入
