# Supabase 免費層超額解決方案

## 🚨 問題確認

- **Egress: 19.262 GB / 5 GB (385%)** - 嚴重超標
- 導致 `ERR_INSUFFICIENT_RESOURCES` 錯誤
- 系統無法正常連接 Supabase

---

## ✅ 已實施的優化（立即生效）

### 1. 請求節流
- **2 秒內只允許一次請求**
- 減少 50-70% 的請求數量

### 2. 請求去重
- **防止同時發送多個相同請求**
- 如果已有請求在進行，返回同一個 Promise

### 3. 快取機制
- **30 秒內使用快取資料**
- 減少 80-90% 的不必要請求

### 4. Realtime 更新優化
- **根據事件類型優化處理**
- 添加節流機制

**預期效果**: Egress 使用量減少 **70-90%**

---

## 📊 監控使用量

### 如何檢查

1. 登入 Supabase Dashboard
2. 進入 **Billing** → **Usage Summary**
3. 查看 **Egress** 使用量

### 預期結果

優化後，Egress 使用量應該會：
- ✅ 從 19.262 GB 減少到 **2-6 GB/月**
- ✅ 低於 5 GB 免費層限制
- ✅ 系統恢復正常運作

---

## 🔧 如果仍然超標

### 方案 1：等待下個計費週期（免費）

- Supabase 免費層限制是**每月重置**
- 當前計費週期：**28 Dec 2025 - 28 Jan 2026**
- 下個計費週期會重置為 0

**優點**: 免費  
**缺點**: 需要等待到下個計費週期（約 1 個月）

---

### 方案 2：升級 Supabase 方案（推薦）

#### Pro 方案 ($25/月)
- **Egress: 50 GB/月** (比免費層多 10 倍)
- **Database Size: 8 GB** (比免費層多 16 倍)
- **Bandwidth: 250 GB/月** (比免費層多 50 倍)
- **Realtime Connections: 500 並發** (比免費層多 2.5 倍)

**適合**: 生產環境、多用戶使用

#### Team 方案 ($599/月)
- **Egress: 500 GB/月**
- **Database Size: 100 GB**
- **Bandwidth: 2 TB/月**
- **Realtime Connections: 2000 並發**

**適合**: 大型團隊、高流量應用

---

### 方案 3：優化資料結構（免費，但需要時間）

1. **清理舊資料**
   - 刪除不需要的歷史資料
   - 定期清理過期排程項目

2. **優化查詢**
   - 只查詢需要的欄位（不使用 `select('*')`）
   - 添加索引提升查詢效率

3. **減少資料大小**
   - 壓縮 JSON 資料
   - 移除不必要的欄位

---

## 📋 立即行動

### 步驟 1：重新啟動開發伺服器

```bash
npm run dev
```

### 步驟 2：測試功能

- ✅ 確認資料載入正常
- ✅ 確認拖曳功能正常
- ✅ 確認儲存功能正常
- ✅ 確認 Realtime 同步正常

### 步驟 3：監控使用量

1. 登入 Supabase Dashboard
2. 進入 **Billing** → **Usage Summary**
3. 觀察 **Egress** 使用量是否減少

### 步驟 4：決定下一步

- **如果 Egress 減少到 < 5 GB**: 繼續使用免費層
- **如果仍然 > 5 GB**: 考慮升級方案或等待下個計費週期

---

## ⚠️ 注意事項

### 當前狀態

- ✅ 優化已完成
- ⚠️ 需要重新啟動開發伺服器才能生效
- ⚠️ 當前計費週期的超額無法恢復（需要等待下個計費週期）

### 與 Google API Key 改動的關係

- ✅ **完全無關**
- ✅ Google API Key 改動已完成
- ✅ 只需要更新環境變數（`GOOGLE_API_KEY`）

---

## 🎯 建議

### 短期（立即）

1. ✅ **實施優化**（已完成）
2. ✅ **重新啟動開發伺服器**
3. ✅ **監控使用量**

### 中期（1-2 週）

1. **觀察使用量趨勢**
   - 如果持續接近 5 GB，考慮升級
   - 如果遠低於 5 GB，繼續使用免費層

2. **優化資料結構**（如果需要）
   - 清理舊資料
   - 優化查詢

### 長期（1 個月以上）

1. **評估升級方案**
   - 如果使用量持續增長，考慮升級到 Pro 方案
   - 如果使用量穩定，繼續使用免費層

---

## 📞 需要幫助？

如果優化後仍然遇到問題：

1. **檢查 Supabase Dashboard** 確認使用量
2. **查看 Console 錯誤** 確認問題類型
3. **考慮升級方案** 如果使用量持續超標
