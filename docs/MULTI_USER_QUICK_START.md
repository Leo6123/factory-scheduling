# å¤šç”¨æˆ¶/å¤šåˆ†é ç®¡ç† - å¿«é€Ÿé–‹å§‹æŒ‡å—

## å•é¡Œèªªæ˜

ç•¶å¤šå€‹ç”¨æˆ¶ï¼ˆæˆ–åŒä¸€ç”¨æˆ¶åœ¨å¤šå€‹åˆ†é /è¨­å‚™ï¼‰åŒæ™‚ä½¿ç”¨ç³»çµ±æ™‚ï¼Œæœƒé‡åˆ°ä»¥ä¸‹å•é¡Œï¼š

1. **è³‡æ–™ä¸åŒæ­¥**ï¼šA ç”¨æˆ¶çš„è®Šæ›´ï¼ŒB ç”¨æˆ¶çœ‹ä¸åˆ°
2. **è³‡æ–™è¡çª**ï¼šå…©å€‹ç”¨æˆ¶åŒæ™‚ä¿®æ”¹ï¼Œæœ€å¾Œä¿å­˜çš„æœƒè¦†è“‹ä¹‹å‰çš„
3. **ä¸çŸ¥é“èª°åœ¨ç·š**ï¼šç„¡æ³•çŸ¥é“æœ‰å“ªäº›ç”¨æˆ¶æ­£åœ¨ä½¿ç”¨ç³»çµ±

## è§£æ±ºæ–¹æ¡ˆ

### éšæ®µ 1ï¼šå•Ÿç”¨å³æ™‚åŒæ­¥ï¼ˆæ¨è–¦å…ˆå¯¦ä½œï¼‰

#### æ­¥é©Ÿ 1ï¼šåœ¨ Supabase å•Ÿç”¨ Realtime

1. å‰å¾€ [Supabase Dashboard](https://supabase.com/dashboard)
2. é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ
3. å·¦å´é¸å–®ï¼š**Database** > **Replication**
4. æ‰¾åˆ° `schedule_items` è¡¨ï¼Œé»æ“Š **Enable Realtime**
5. æ‰¾åˆ° `line_configs` è¡¨ï¼Œé»æ“Š **Enable Realtime**

#### æ­¥é©Ÿ 2ï¼šåŸ·è¡Œ SQL è…³æœ¬

åœ¨ Supabase Dashboard > **SQL Editor** ä¸­åŸ·è¡Œï¼š

```sql
-- åŸ·è¡Œ supabase_enable_realtime.sql
```

æˆ–æ‰‹å‹•åŸ·è¡Œï¼š

```sql
-- æ·»åŠ æ´»å‹•ç”¨æˆ¶è¿½è¹¤æ¬„ä½
ALTER TABLE public.user_profiles 
ADD COLUMN IF NOT EXISTS last_active_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();

CREATE INDEX IF NOT EXISTS idx_user_profiles_last_active_at 
ON public.user_profiles(last_active_at DESC);
```

#### æ­¥é©Ÿ 3ï¼šåœ¨æ‡‰ç”¨ç¨‹å¼ä¸­ä½¿ç”¨

**åœ¨ `src/components/Swimlane.tsx` ä¸­ï¼š**

```typescript
import { useRealtimeSchedule } from '@/hooks/useRealtimeSchedule';

// åœ¨çµ„ä»¶ä¸­
const { isSubscribed } = useRealtimeSchedule({
  onScheduleChange: (items) => {
    // ç•¶æ”¶åˆ°å³æ™‚è®Šæ›´æ™‚ï¼Œæ›´æ–°æœ¬åœ°ç‹€æ…‹
    setScheduleItems(items);
  },
  onError: (error) => {
    console.error('å³æ™‚åŒæ­¥éŒ¯èª¤:', error);
    // å¯ä»¥é¡¯ç¤ºéŒ¯èª¤æç¤ºçµ¦ç”¨æˆ¶
  },
});
```

**åœ¨ `src/app/page.tsx` ä¸­é¡¯ç¤ºæ´»å‹•ç”¨æˆ¶ï¼š**

```typescript
import ActiveUsersIndicator from '@/components/ActiveUsersIndicator';

// åœ¨ Header ä¸­æ·»åŠ 
<div className="flex items-center gap-4">
  <ActiveUsersIndicator />
  {/* å…¶ä»–å…§å®¹ */}
</div>
```

---

## æ¸¬è©¦æ–¹æ³•

### æ¸¬è©¦å³æ™‚åŒæ­¥

1. **é–‹å•Ÿå…©å€‹ç€è¦½å™¨åˆ†é **ï¼ˆæˆ–å…©å€‹ä¸åŒè¨­å‚™ï¼‰
2. **å…©å€‹åˆ†é éƒ½ç™»å…¥**åŒä¸€å€‹æˆ–ä¸åŒçš„å¸³è™Ÿ
3. **åœ¨åˆ†é  A**ï¼šæ‹–æ›³ä¸€å€‹å¡ç‰‡åˆ°æ™‚é–“è»¸
4. **åœ¨åˆ†é  B**ï¼šæ‡‰è©²åœ¨ 1-2 ç§’å…§çœ‹åˆ°å¡ç‰‡è‡ªå‹•å‡ºç¾
5. **åœ¨åˆ†é  B**ï¼šä¿®æ”¹å¡ç‰‡çš„æ•¸é‡
6. **åœ¨åˆ†é  A**ï¼šæ‡‰è©²çœ‹åˆ°æ•¸é‡è‡ªå‹•æ›´æ–°

### æ¸¬è©¦æ´»å‹•ç”¨æˆ¶é¡¯ç¤º

1. **é–‹å•Ÿå…©å€‹åˆ†é **ï¼Œéƒ½ç™»å…¥
2. **æŸ¥çœ‹å³ä¸Šè§’**ï¼šæ‡‰è©²é¡¯ç¤ºã€Œ2 äººåœ¨ç·šã€
3. **é—œé–‰ä¸€å€‹åˆ†é **ï¼šç­‰å¾… 30 ç§’å¾Œï¼Œæ‡‰è©²é¡¯ç¤ºã€Œ1 äººåœ¨ç·šã€

---

## ç›®å‰é™åˆ¶

### âš ï¸ å·²çŸ¥å•é¡Œ

1. **è¡çªè™•ç†**ï¼šå¦‚æœå…©å€‹ç”¨æˆ¶åŒæ™‚ä¿®æ”¹åŒä¸€é …ç›®ï¼Œæœ€å¾Œä¿å­˜çš„æœƒè¦†è“‹
2. **ç¶²è·¯ä¸­æ–·**ï¼šå¦‚æœç¶²è·¯ä¸­æ–·ï¼Œå³æ™‚åŒæ­¥æœƒåœæ­¢ï¼Œéœ€è¦é‡æ–°æ•´ç†é é¢
3. **æ€§èƒ½**ï¼šå¤§é‡è®Šæ›´æ™‚ï¼Œå¯èƒ½æœƒæœ‰ä¸€äº›å»¶é²

### ğŸ”„ æœªä¾†æ”¹é€²

- [ ] ç·¨è¼¯é–å®šï¼ˆé˜²æ­¢åŒæ™‚ç·¨è¼¯ï¼‰
- [ ] è¡çªè§£æ±ºå°è©±æ¡†
- [ ] è®Šæ›´æ­·å²è¨˜éŒ„
- [ ] å”ä½œæç¤ºï¼ˆé¡¯ç¤ºèª°åœ¨ç·¨è¼¯ä»€éº¼ï¼‰

---

## Session ç®¡ç†èªªæ˜

### å¤šåˆ†é è¡Œç‚º

- âœ… **æ¯å€‹åˆ†é ç¨ç«‹**ï¼šæ¯å€‹ç€è¦½å™¨åˆ†é éƒ½æœ‰ç¨ç«‹çš„ Supabase session
- âœ… **å¯ä»¥åŒæ™‚ä½¿ç”¨**ï¼šå¯ä»¥åœ¨å¤šå€‹åˆ†é åŒæ™‚æ“ä½œ
- âš ï¸ **ç™»å‡ºå½±éŸ¿**ï¼šåœ¨ä¸€å€‹åˆ†é ç™»å‡ºï¼Œå…¶ä»–åˆ†é çš„ session æœƒå¤±æ•ˆï¼ˆéœ€è¦é‡æ–°ç™»å…¥ï¼‰

### å¤šè¨­å‚™è¡Œç‚º

- âœ… **ç¨ç«‹ Session**ï¼šæ¯å€‹è¨­å‚™/ç€è¦½å™¨éƒ½æœ‰ç¨ç«‹çš„ session
- âœ… **åŒæ™‚åœ¨ç·š**ï¼šåŒä¸€ç”¨æˆ¶å¯ä»¥åœ¨å¤šå€‹è¨­å‚™åŒæ™‚ç™»å…¥
- âœ… **è³‡æ–™åŒæ­¥**ï¼šé€šé Supabase Realtime åŒæ­¥ï¼ˆå•Ÿç”¨å¾Œï¼‰

---

## æ•…éšœæ’é™¤

### å³æ™‚åŒæ­¥ä¸å·¥ä½œ

1. **æª¢æŸ¥ Realtime æ˜¯å¦å•Ÿç”¨**
   - Supabase Dashboard > Database > Replication
   - ç¢ºèª `schedule_items` å’Œ `line_configs` éƒ½å·²å•Ÿç”¨

2. **æª¢æŸ¥æ§åˆ¶å°**
   - æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ï¼ˆF12ï¼‰
   - æŸ¥çœ‹ Consoleï¼Œæ‡‰è©²çœ‹åˆ°ã€Œâœ… å·²æˆåŠŸè¨‚é–± schedule_items å³æ™‚è®Šæ›´ã€

3. **æª¢æŸ¥ç¶²è·¯é€£ç·š**
   - ç¢ºèªç¶²è·¯æ­£å¸¸
   - æª¢æŸ¥ Supabase æœå‹™ç‹€æ…‹

### æ´»å‹•ç”¨æˆ¶ä¸é¡¯ç¤º

1. **æª¢æŸ¥ SQL è…³æœ¬æ˜¯å¦åŸ·è¡Œ**
   - ç¢ºèª `user_profiles` è¡¨æœ‰ `last_active_at` æ¬„ä½

2. **æª¢æŸ¥æ¬Šé™**
   - ç¢ºèª RLS æ”¿ç­–å…è¨±è®€å– `user_profiles` è¡¨

---

## ç›¸é—œæ–‡ä»¶

- [å®Œæ•´æ–¹æ¡ˆæ–‡æª”](./MULTI_USER_MANAGEMENT.md)
- [Supabase Realtime æ–‡æª”](https://supabase.com/docs/guides/realtime)
